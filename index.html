<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>B-Drive</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{ --green:#00ff66; }
*{ box-sizing:border-box; }

body{
  margin:0;
  background:#000;
  color:var(--green);
  font-family:"Courier New", monospace;
}

/* HEADER */
header{
  padding:14px;
  text-align:center;
  font-size:22px;
  border-bottom:1px solid var(--green);
  text-shadow:0 0 10px var(--green);
}

/* ================= LOGIN ================= */
.login-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.95);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:10000;
}
.login-box{
  border:2px solid var(--green);
  padding:20px;
  border-radius:14px;
  width:90%;
  max-width:320px;
  text-align:center;
}
.login-box input{
  width:100%;
  padding:10px;
  background:#000;
  border:1px solid var(--green);
  color:var(--green);
  border-radius:999px;
  text-align:center;
}
.login-error{
  color:red;
  margin-top:10px;
  display:none;
}

/* ================= STATUS ================= */
.status{
  display:flex;
  justify-content:center;
  padding:10px;
}
.status-box{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 14px;
  border:1px solid var(--green);
  border-radius:999px;
  font-size:12px;
}
.spinner{
  width:14px;height:14px;
  border:2px solid #003d1f;
  border-top:2px solid var(--green);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{100%{transform:rotate(360deg)}}
.tick{display:none}

/* CONTAINER */
.container{
  max-width:1200px;
  margin:auto;
  padding:16px;
}

/* TOOLBAR */
.toolbar{
  display:flex;
  justify-content:center;
  gap:6px;
  flex-wrap:wrap;
  margin-bottom:14px;
}
button{
  background:transparent;
  color:var(--green);
  border:1px solid var(--green);
  padding:5px 10px;
  border-radius:999px;
  font-size:12px;
  cursor:pointer;
}
button:hover{background:var(--green);color:#000}

/* PROGRESS */
.progress-box{
  display:none;
  border:1px solid var(--green);
  border-radius:10px;
  padding:6px;
  margin-bottom:12px;
}
.progress{
  height:8px;
  background:#003d1f;
  border-radius:10px;
  overflow:hidden;
}
.progress-bar{
  height:100%;
  width:0%;
  background:var(--green);
}
.cancel-btn{
  margin-top:6px;
  border:1px solid red;
  color:red;
  background:transparent;
  border-radius:999px;
  font-size:11px;
}

/* IMAGE GRID */
.thumb-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(90px,1fr));
  gap:10px;
  margin-bottom:16px;
}
.thumb{
  border:1px solid #003d1f;
  padding:5px;
  border-radius:8px;
  background:#020e07;
  position:relative;
}
.thumb img{
  width:100%;
  height:65px;
  object-fit:cover;
  border-radius:6px;
}
.thumb-name{
  font-size:10px;
  white-space:nowrap;
  overflow:hidden;
}

/* FILE LIST */
.file-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-bottom:1px solid #003d1f;
}
.file-row:hover{ background:#021a0c; }
.filename{
  max-width:260px;
  white-space:nowrap;
  overflow:hidden;
}

/* MENU */
.menu{ position:relative; }
.menu-btn{ cursor:pointer; font-size:16px; }
.menu-box{
  display:none;
  position:absolute;
  right:0;
  top:20px;
  background:#000;
  border:1px solid var(--green);
  min-width:150px;
  z-index:99;
}
.menu-box div{
  padding:8px 12px;
  font-size:12px;
  cursor:pointer;
}
.menu-box div:hover{background:var(--green);color:#000}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-box{
  background:#000;
  border:2px solid var(--green);
  padding:12px;
  width:90%;
  max-width:700px;
}

/* DETAILS */
.details-row{
  margin:6px 0;
  text-align:left;
  font-size:13px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h3>Enter your password</h3>
    <input type="password" id="loginPassword">
    <button onclick="checkLogin()">Login</button>
    <div class="login-error" id="loginError">Password incorrect</div>
  </div>
</div>

<header>‚òÅÔ∏è B-Drive</header>

<div class="status">
  <div class="status-box">
    <div class="spinner" id="spinner"></div>
    <div class="tick" id="tick">‚úî</div>
    <span id="statusText">Connecting‚Ä¶</span>
  </div>
</div>

<div class="container">

  <div class="toolbar">
    <button onclick="goHome()">Home</button>
    <button onclick="goBack()">Back</button>
    <button onclick="createFolder()">New Folder</button>
    <button onclick="pickFile()">Upload</button>
    <button onclick="refreshList()">Refresh</button>
  </div>

  <div class="progress-box" id="progressBox">
    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
    <button class="cancel-btn" onclick="cancelUpload()">Cancel Upload</button>
  </div>

  <input type="file" id="fileInput" multiple hidden>

  <div id="thumbGrid" class="thumb-grid"></div>
  <div id="fileList"></div>
</div>

<!-- PREVIEW -->
<div class="modal" id="viewer">
  <div class="modal-box">
    <button onclick="closeViewer()">Close</button>
    <div id="viewerBody"></div>
  </div>
</div>

<!-- DETAILS -->
<div class="modal" id="detailsModal">
  <div class="modal-box">
    <button onclick="closeDetails()">Close</button>
    <div id="detailsBody"></div>
  </div>
</div>

<script>
/* ================= LOGIN ================= */
function checkLogin(){
  const p=loginPassword.value;
  if(p==="1234"){
    loginOverlay.style.display="none";
  }else{
    loginError.style.display="block";
    setTimeout(()=>loginError.style.display="none",1500);
  }
}

/* ================= CORE ================= */
const API="https://b-drive-backend.onrender.com";
let currentPath="storage";
let history=[];
let currentXHR=null;

/* CONNECT */
(async()=>{
  try{
    await fetch(API+"/ping");
    spinner.style.display="none";
    tick.style.display="block";
    statusText.textContent="Connected";
    loadList();
  }catch{
    statusText.textContent="Offline";
  }
})();

function isImage(n){return /\.(png|jpg|jpeg|gif|webp)$/i.test(n);}

/* LOAD */
async function loadList(path=currentPath){
  currentPath=path;
  const r=await fetch(API+"/list?path="+path);
  let items=await r.json();
  if(!Array.isArray(items)) items=[items];
  render(items);
}
function refreshList(){loadList(currentPath);}

/* RENDER */
function render(items){
  fileList.innerHTML="";
  thumbGrid.innerHTML="";

  items.forEach(i=>{
    if(i.type==="file" && isImage(i.name)){
      thumbGrid.innerHTML+=`
      <div class="thumb">
        <img src="${i.download_url}" onclick="openPreview('${i.download_url}','${i.name}')">
        <div class="thumb-name">${i.name}</div>
        <div class="menu">
          <span class="menu-btn" onclick="openMenu(event,this)">‚ãÆ</span>
          <div class="menu-box">
            <div onclick='showDetails(${JSON.stringify(i)})'>Details</div>
            <div onclick="renameItem('${i.path}','${i.name}','file')">Rename</div>
            <div onclick="openPreview('${i.download_url}','${i.name}')">Preview</div>
            <div onclick="downloadFile('${i.download_url}','${i.name}')">Download</div>
            <div onclick="deleteItem('${i.path}','file','${i.sha}')">Delete</div>
          </div>
        </div>
      </div>`;
      return;
    }

    fileList.innerHTML+=`
    <div class="file-row" onclick="openFolder(event,'${i.path}','${i.type}')">
      <span class="filename">${i.type==="dir"?"üìÅ ":""}${i.name}</span>
      <div class="menu">
        <span class="menu-btn" onclick="openMenu(event,this)">‚ãÆ</span>
        <div class="menu-box">
          <div onclick='showDetails(${JSON.stringify(i)})'>Details</div>
          <div onclick="renameItem('${i.path}','${i.name}','${i.type}')">Rename</div>
          ${i.type==="file"?`<div onclick="openPreview('${i.download_url}','${i.name}')">Preview</div>`:""}
          ${i.type==="file"?`<div onclick="downloadFile('${i.download_url}','${i.name}')">Download</div>`:""}
          <div onclick="deleteItem('${i.path}','${i.type}','${i.sha||""}')">Delete</div>
        </div>
      </div>
    </div>`;
  });
}

/* MENU */
function openFolder(e,p,t){
  if(e.target.closest(".menu")) return;
  if(t==="dir"){history.push(currentPath);loadList(p);}
}
function openMenu(e,el){
  e.stopPropagation();
  closeMenus();
  el.nextElementSibling.style.display="block";
}
function closeMenus(){
  document.querySelectorAll(".menu-box").forEach(m=>m.style.display="none");
}
document.addEventListener("click",closeMenus);

/* DETAILS */
function showDetails(i){
  detailsBody.innerHTML=`
    <div class="details-row"><b>Name:</b> ${i.name}</div>
    <div class="details-row"><b>Type:</b> ${i.type}</div>
    <div class="details-row"><b>Path:</b> ${i.path}</div>
    ${i.size?`<div class="details-row"><b>Size:</b> ${Math.round(i.size/1024)} KB</div>`:""}
  `;
  detailsModal.style.display="flex";
}
function closeDetails(){detailsModal.style.display="none";}

/* REAL FILE RENAME (ADD ONLY) */
async function renameItem(path,oldName,type){
  const newName=prompt("Enter new name",oldName);
  if(!newName||newName===oldName) return;

  if(type==="dir"){
    alert("Folder rename needs recursive copy.\nTell me if you want it added.");
    return;
  }

  try{
    const r=await fetch(API+"/list?path="+path);
    const file=await r.json();

    const parent=path.substring(0,path.lastIndexOf("/"));
    const fd=new FormData();
    fd.append("path",parent);
    fd.append(
      "file",
      new Blob([atob(file.content)],{type:"application/octet-stream"}),
      newName
    );

    await fetch(API+"/upload",{method:"POST",body:fd});

    await fetch(API+"/delete",{
      method:"DELETE",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({path,sha:file.sha})
    });

    loadList(currentPath);
  }catch(e){
    alert("Rename failed");
  }
}

/* UPLOAD */
function pickFile(){fileInput.click();}
fileInput.onchange=()=>{
  [...fileInput.files].forEach(f=>{
    const fd=new FormData();
    fd.append("file",f);
    fd.append("path",currentPath);
    const xhr=new XMLHttpRequest();
    currentXHR=xhr;
    xhr.upload.onprogress=e=>{
      progressBox.style.display="block";
      progressBar.style.width=(e.loaded/e.total*100)+"%";
    };
    xhr.onload=()=>{
      progressBox.style.display="none";
      progressBar.style.width="0%";
      loadList(currentPath);
    };
    xhr.open("POST",API+"/upload");
    xhr.send(fd);
  });
};
function cancelUpload(){
  if(currentXHR) currentXHR.abort();
  progressBox.style.display="none";
  progressBar.style.width="0%";
}

/* PREVIEW */
function openPreview(url,name){
  let html="Preview not supported";
  if(isImage(name)) html=`<img src="${url}">`;
  else if(/\.pdf$/i.test(name)) html=`<iframe src="${url}" width="100%" height="400"></iframe>`;
  else if(/\.(mp3|wav)$/i.test(name)) html=`<audio src="${url}" controls></audio>`;
  else if(/\.(mp4|webm)$/i.test(name)) html=`<video src="${url}" controls></video>`;
  else if(/\.(docx|xlsx|pptx)$/i.test(name))
    html=`<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}" width="100%" height="400"></iframe>`;
  viewerBody.innerHTML=html;
  viewer.style.display="flex";
}
function closeViewer(){viewer.style.display="none";}
function downloadFile(u,n){const a=document.createElement("a");a.href=u;a.download=n;a.click();}

/* DELETE */
async function deleteItem(path,type,sha){
  if(!confirm("Delete permanently?")) return;
  if(type==="file"){
    await fetch(API+"/delete",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({path,sha})});
  }else{
    const r=await fetch(API+"/list?path="+path);
    const items=await r.json();
    for(const it of items){
      await deleteItem(it.path,it.type,it.sha);
    }
  }
  loadList(currentPath);
}

/* NAV */
function goBack(){if(history.length)loadList(history.pop());}
function goHome(){history=[];loadList("storage");}
function createFolder(){
  const n=prompt("Folder name?");
  if(!n)return;
  fetch(API+"/folder",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:currentPath+"/"+n})})
  .then(()=>loadList(currentPath));
}
</script>

</body>
</html>
