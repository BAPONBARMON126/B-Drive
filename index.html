<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>B-Drive | Cloud Storage</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{ --green:#00ff66; }
*{ box-sizing:border-box; }

body{
  margin:0;
  background:#000;
  color:var(--green);
  font-family:"Courier New", monospace;
}

/* HEADER */
header{
  padding:12px;
  text-align:center;
  font-size:20px;
  border-bottom:1px solid var(--green);
  text-shadow:0 0 10px var(--green);
}

/* STATUS */
.status{
  display:flex;
  justify-content:center;
  padding:10px;
}
.status-box{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 14px;
  border:1px solid var(--green);
  border-radius:999px;
  box-shadow:0 0 10px rgba(0,255,102,.4);
}
.spinner{
  width:14px;height:14px;
  border:2px solid #003d1f;
  border-top:2px solid var(--green);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{100%{transform:rotate(360deg)}}
.tick{display:none;font-weight:bold}

/* CONTAINER */
.container{
  max-width:900px;
  margin:auto;
  padding:14px;
}

/* TOOLBAR */
.toolbar{
  display:flex;
  justify-content:center;
  gap:8px;
  flex-wrap:nowrap;
  margin-bottom:14px;
}
.toolbar button{
  background:transparent;
  color:var(--green);
  border:1px solid var(--green);
  padding:6px 14px;
  border-radius:999px;
  cursor:pointer;
  font-size:13px;
}
.toolbar button:hover{
  background:var(--green);
  color:#000;
}

/* FILE LIST */
.file-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-bottom:1px solid #003d1f;
  cursor:pointer;
}
.file-row:hover{ background:#021a0c; }

.filename{
  max-width:260px;
  overflow:hidden;
  white-space:nowrap;
}

/* MENU */
.menu{ position:relative; }
.menu-btn{
  cursor:pointer;
  font-size:18px;
  padding:4px 6px;
}
.menu-box{
  display:none;
  position:absolute;
  right:0;
  top:22px;
  background:#000;
  border:1px solid var(--green);
  min-width:140px;
  z-index:99;
}
.menu-box div{
  padding:8px 12px;
  cursor:pointer;
  font-size:13px;
}
.menu-box div:hover{
  background:var(--green);
  color:#000;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-box{
  background:#000;
  border:2px solid var(--green);
  padding:16px;
  max-width:700px;
  width:90%;
}
.modal-box iframe,
.modal-box img,
.modal-box video,
.modal-box audio{
  max-width:100%;
  max-height:70vh;
}
</style>
</head>

<body>

<header>‚òÅÔ∏è B-Drive</header>

<div class="status">
  <div class="status-box">
    <div class="spinner" id="spinner"></div>
    <div class="tick" id="tick">‚úî</div>
    <span id="statusText">Connecting‚Ä¶</span>
  </div>
</div>

<div class="container">
  <div class="toolbar">
    <button onclick="goBack()">Back</button>
    <button onclick="createFolder()">New Folder</button>
    <button onclick="pickFile()">Upload</button>
    <button onclick="refreshList()">Refresh</button>
  </div>

  <input type="file" id="fileInput" multiple hidden>
  <div id="fileList"></div>
</div>

<!-- VIEW / DETAILS MODAL -->
<div class="modal" id="viewer">
  <div class="modal-box">
    <button onclick="closeViewer()">Close</button>
    <div id="viewerBody"></div>
  </div>
</div>

<script>
const API = "https://b-drive-backend.onrender.com";
let currentPath = "storage";
let history = [];

/* CONNECT */
(async()=>{
  const r = await fetch(API + "/ping");
  const d = await r.json();
  if(d.status === "ok"){
    spinner.style.display="none";
    tick.style.display="block";
    statusText.textContent="Connected";
    loadList();
  }
})();

/* LOAD LIST */
async function loadList(path=currentPath){
  currentPath = path;
  const r = await fetch(API + "/list?path=" + currentPath);
  let items = await r.json();
  if(!Array.isArray(items)) items=[items];
  render(items);
}
function refreshList(){ loadList(currentPath); }

/* RENDER */
function render(items){
  fileList.innerHTML="";
  const folders = items.filter(i=>i.type==="dir");
  const files   = items.filter(i=>i.type==="file");

  [...folders,...files].forEach(i=>{
    const row=document.createElement("div");
    row.className="file-row";

    row.onclick=(e)=>{
      if(e.target.closest(".menu")) return;
      if(i.type==="dir"){
        history.push(currentPath);
        loadList(i.path);
      }else{
        previewFile(i.download_url);
      }
    };

    row.innerHTML=`
      <span class="filename">${i.type==="dir"?"üìÅ ":""}${i.name}</span>
      <div class="menu">
        <span class="menu-btn">‚ãÆ</span>
        <div class="menu-box">
          ${i.type==="file"?`<div onclick="menuPreview(event,'${i.download_url}')">Preview</div>`:""}
          ${i.type==="file"?`<div onclick="menuDownload(event,'${i.download_url}','${i.name}')">Download</div>`:""}
          <div onclick="menuDetails(event,'${i.path}')">Details</div>
          <div onclick="menuDelete(event,'${i.path}','${i.sha||""}','${i.type}')">Delete</div>
        </div>
      </div>
    `;

    const btn=row.querySelector(".menu-btn");
    const box=row.querySelector(".menu-box");

    btn.onclick=(e)=>{
      e.stopPropagation();
      closeAllMenus();
      box.style.display="block";
    };

    fileList.appendChild(row);
  });
}

/* MENU HELPERS */
document.addEventListener("click", closeAllMenus);
function closeAllMenus(){
  document.querySelectorAll(".menu-box")
    .forEach(m=>m.style.display="none");
}

function menuPreview(e,url){
  e.stopPropagation();
  previewFile(url);
}

function menuDownload(e,url,name){
  e.stopPropagation();
  const a=document.createElement("a");
  a.href=url;
  a.download=name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

async function menuDetails(e,path){
  e.stopPropagation();
  const r=await fetch(API+"/details?path="+path);
  const d=await r.json();

  viewerBody.innerHTML=`
    <h3>Details</h3>
    <p><b>Name:</b> ${d.name}</p>
    <p><b>Type:</b> ${d.type}</p>
    <p><b>Path:</b> ${d.path}</p>
    <p><b>Size:</b> ${(d.size/1024).toFixed(2)} KB</p>
    ${d.filesCount!==undefined?`<p><b>Files:</b> ${d.filesCount}</p>`:""}
    <p><b>Last Modified:</b> ${d.lastModified || "N/A"}</p>
  `;
  viewer.style.display="flex";
}

async function menuDelete(e,path,sha,type){
  e.stopPropagation();
  if(!confirm("Delete?")) return;

  await fetch(API+"/delete",{
    method:"DELETE",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({path,sha})
  });

  loadList(currentPath);
}

/* PREVIEW */
function previewFile(url){
  let html="Preview not supported";
  if(url.match(/\.(png|jpg|jpeg|webp)$/i))
    html=`<img src="${url}">`;
  else if(url.endsWith(".pdf"))
    html=`<iframe src="${url}" width="100%" height="500"></iframe>`;
  else if(url.match(/\.(mp4)$/i))
    html=`<video src="${url}" controls></video>`;
  else if(url.match(/\.(mp3)$/i))
    html=`<audio src="${url}" controls></audio>`;

  viewerBody.innerHTML=html;
  viewer.style.display="flex";
}
function closeViewer(){ viewer.style.display="none"; }

/* UPLOAD */
function pickFile(){ fileInput.click(); }
fileInput.onchange=()=>{
  [...fileInput.files].forEach(f=>{
    const fd=new FormData();
    fd.append("file",f);
    fd.append("path",currentPath);
    fetch(API+"/upload",{method:"POST",body:fd})
      .then(()=>loadList(currentPath));
  });
};

/* CREATE FOLDER */
function createFolder(){
  const name=prompt("Folder name?");
  if(!name) return;
  fetch(API+"/folder",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({path:currentPath+"/"+name})
  }).then(()=>loadList(currentPath));
}

/* NAV */
function goBack(){
  if(!history.length) return;
  loadList(history.pop());
}
</script>

</body>
</html>
