<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>B-Drive | Cloud File Storage</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{ --green:#00ff66; }
*{ box-sizing:border-box; }

body{
  margin:0;
  background:#000;
  color:var(--green);
  font-family:"Courier New", monospace;
}

header{
  padding:14px;
  text-align:center;
  font-size:20px;
  border-bottom:1px solid var(--green);
  text-shadow:0 0 10px var(--green);
}

/* ===== STATUS ===== */
.status{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  padding:8px;
}
.spinner{
  width:18px;height:18px;
  border:2px solid #003d1f;
  border-top:2px solid var(--green);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{100%{transform:rotate(360deg)}}
.tick{display:none;font-weight:bold}

/* ===== LAYOUT ===== */
.container{
  max-width:900px;
  margin:auto;
  padding:16px;
  text-align:center;
}
.toolbar{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:16px;
}

/* ===== BUTTONS ===== */
button{
  background:transparent;
  color:var(--green);
  border:1px solid var(--green);
  padding:8px 18px;
  border-radius:999px;
  cursor:pointer;
  text-shadow:0 0 6px var(--green);
}
button:hover{
  background:var(--green);
  color:#000;
  box-shadow:0 0 15px var(--green);
}
input[type=file]{ display:none; }

/* ===== FILE LIST ===== */
.file-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-bottom:1px solid #003d1f;
}
.file-row:hover{ background:#021a0c; }

.filename{
  max-width:240px;
  overflow:hidden;
  white-space:nowrap;
}
.actions button{ margin-left:6px; }

/* ===== MODAL ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-box{
  background:#000;
  border:2px solid var(--green);
  border-radius:16px;
  padding:16px;
  width:90%;
  max-width:850px;
  box-shadow:0 0 25px var(--green);
  text-align:center;
}
.modal-box iframe,
.modal-box img,
.modal-box video,
.modal-box audio{
  max-width:100%;
  max-height:70vh;
  border-radius:12px;
}

/* ===== PROGRESS ===== */
.progress{
  width:100%;
  height:10px;
  border:1px solid var(--green);
  margin-top:12px;
  border-radius:10px;
}
.bar{
  height:100%;
  width:0%;
  background:var(--green);
  box-shadow:0 0 10px var(--green);
  border-radius:10px;
}
</style>
</head>

<body>

<header>‚òÅÔ∏è B-Drive Cloud Storage</header>

<div class="status">
  <div class="spinner" id="spinner"></div>
  <div class="tick" id="tick">‚úî CONNECTED</div>
  <span id="statusText">Connecting‚Ä¶</span>
</div>

<div class="container">
  <div class="toolbar">
    <button onclick="goBack()">‚¨Ö Back</button>
    <button onclick="createFolder()">üìÅ New Folder</button>
    <button onclick="upload()">‚¨Ü Upload</button>
  </div>
  <input type="file" id="fileInput" multiple>
  <div id="fileList"></div>
</div>

<!-- POPUP / PREVIEW -->
<div class="modal" id="popup">
  <div class="modal-box">
    <button onclick="closePopup()">‚úñ Close</button>
    <div id="popupBody"></div>
    <div class="progress" id="progressBox" style="display:none">
      <div class="bar" id="progressBar"></div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API="https://b-drive-backend.onrender.com";
let currentPath="storage";
let history=[];

/* ===== NAME SHORTENER (ONLY CHANGE YOU ASKED) ===== */
function shortName(name){
  const words = name.split(" ");
  if(words.length <= 7) return name;
  return words.slice(0,7).join(" ") + "...";
}

/* ===== CONNECTION ===== */
async function checkConnection(){
  try{
    const r=await fetch(API+"/ping");
    const d=await r.json();
    if(d.status==="ok"){
      spinner.style.display="none";
      tick.style.display="block";
      statusText.textContent="Server Connected";
      loadList();
    }
  }catch{
    setTimeout(checkConnection,3000);
  }
}
checkConnection();

/* ===== LIST ===== */
async function loadList(){
  const r=await fetch(API+"/list?path="+currentPath);
  const items=await r.json();
  render(items);
}

function render(items){
  fileList.innerHTML="";
  const folders = items.filter(i=>i.type==="dir");
  const files   = items.filter(i=>i.type==="file");

  [...folders, ...files].forEach(i=>{
    const row=document.createElement("div");
    row.className="file-row";

    if(i.type==="dir"){
      row.innerHTML=`
        <span class="filename" title="${i.name}">üìÅ <b>${shortName(i.name)}</b></span>
        <div class="actions">
          <button onclick="openFolder(event,'${i.path}')">üìÇ</button>
          <button onclick="deleteFolder(event,'${i.path}')">üóë</button>
        </div>`;
    }else{
      row.innerHTML=`
        <span class="filename" title="${i.name}">${shortName(i.name)}</span>
        <div class="actions">
          <button onclick="viewFile(event,'${i.download_url}')">üëÅ</button>
          <button onclick="downloadFile(event,'${i.download_url}','${i.name}')">üì•</button>
          <button onclick="deleteFile(event,'${i.path}','${i.sha}')">üóë</button>
        </div>`;
    }
    fileList.appendChild(row);
  });
}

/* ===== NAV ===== */
function openFolder(e,path){
  e.stopPropagation();
  history.push(currentPath);
  currentPath=path;
  loadList();
}
function goBack(){
  if(!history.length) return;
  currentPath=history.pop();
  loadList();
}

/* ===== UPLOAD ===== */
function upload(){ fileInput.click(); }

fileInput.onchange=()=>{
  [...fileInput.files].forEach(f=>{
    if(f.size>100*1024*1024){ alert("Max 100MB"); return; }
    showPopup("Uploading "+f.name);
    uploadWithProgress(f);
  });
};

function uploadWithProgress(file){
  progressBox.style.display="block";
  progressBar.style.width="0%";
  const fd=new FormData();
  fd.append("file",file);
  fd.append("path",currentPath);

  const xhr=new XMLHttpRequest();
  xhr.upload.onprogress=e=>{
    if(e.lengthComputable){
      progressBar.style.width=(e.loaded/e.total*100)+"%";
    }
  };
  xhr.onload=()=>{
    showPopup("Upload completed ‚úî");
    progressBox.style.display="none";
    loadList();
  };
  xhr.open("POST",API+"/upload");
  xhr.send(fd);
}

/* ===== DELETE FILE ===== */
function deleteFile(e,path,sha){
  e.stopPropagation();
  if(!confirm("Delete this file?")) return;
  fetch(API+"/delete",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({path,sha})})
  .then(()=>loadList());
}

/* ===== DELETE FOLDER ===== */
async function deleteFolder(e,folderPath){
  e.stopPropagation();
  if(!confirm("Delete this folder and all files inside?")) return;

  const r=await fetch(API+"/list?path="+folderPath);
  const items=await r.json();
  for(const i of items){
    if(i.type==="file"){
      await fetch(API+"/delete",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:i.path,sha:i.sha})});
    }
  }
  loadList();
}

/* ===== PREVIEW ===== */
function viewFile(e,url){
  e.stopPropagation();
  let html="Preview not supported";
  if(url.match(/\.(png|jpg|jpeg|webp)$/i)) html=`<img src="${url}">`;
  else if(url.endsWith(".pdf")) html=`<iframe src="${url}" width="100%" height="500"></iframe>`;
  else if(url.match(/\.(mp4)$/i)) html=`<video src="${url}" controls></video>`;
  else if(url.match(/\.(mp3)$/i)) html=`<audio src="${url}" controls></audio>`;
  else if(url.match(/\.(docx|xlsx|pptx)$/i))
    html=`<iframe src="https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}" width="100%" height="500"></iframe>`;
  popupBody.innerHTML=html;
  popup.style.display="flex";
}

/* ===== DOWNLOAD ===== */
function downloadFile(e,url,name){
  e.stopPropagation();
  const a=document.createElement("a");
  a.href=url; a.download=name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ===== POPUP ===== */
function showPopup(msg){
  popupBody.innerHTML="<p>"+msg+"</p>";
  popup.style.display="flex";
}
function closePopup(){ popup.style.display="none"; }
</script>

</body>
</html>
