<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>B-Drive | Cloud Storage</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{ --green:#00ff66; }
*{ box-sizing:border-box; }

body{
  margin:0;
  background:#000;
  color:var(--green);
  font-family:"Courier New", monospace;
}

/* HEADER */
header{
  padding:12px;
  text-align:center;
  font-size:20px;
  border-bottom:1px solid var(--green);
  text-shadow:0 0 8px var(--green);
}

/* STATUS */
.status{
  display:flex;
  justify-content:center;
  padding:10px;
}
.status-box{
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border:1px solid var(--green);
  border-radius:999px;
  font-size:12px;
}
.spinner{
  width:12px;height:12px;
  border:2px solid #003d1f;
  border-top:2px solid var(--green);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{100%{transform:rotate(360deg)}}
.tick{display:none}

/* CONTAINER */
.container{
  max-width:1100px;
  margin:auto;
  padding:14px;
}

/* TOOLBAR ‚Äì COMPACT & RESPONSIVE */
.toolbar{
  display:flex;
  justify-content:center;
  gap:6px;
  flex-wrap:wrap;          /* üî• wrap instead of scroll */
  margin-bottom:14px;
}
.toolbar button{
  background:transparent;
  color:var(--green);
  border:1px solid var(--green);
  padding:5px 10px;        /* üî• smaller */
  border-radius:999px;
  cursor:pointer;
  font-size:12px;          /* üî• smaller text */
  line-height:1;
}
.toolbar button:hover{
  background:var(--green);
  color:#000;
}

/* PROGRESS */
.progress{
  height:8px;
  border:1px solid var(--green);
  border-radius:10px;
  margin-bottom:10px;
  display:none;
}
.bar{
  height:100%;
  width:0%;
  background:var(--green);
}

/* FILE LIST */
.file-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-bottom:1px solid #003d1f;
}
.file-row:hover{ background:#021a0c; }

.filename{
  max-width:260px;
  overflow:hidden;
  white-space:nowrap;
  font-size:13px;
}

/* MENU */
.menu{ position:relative; }
.menu-btn{
  cursor:pointer;
  font-size:16px;
  padding:2px 4px;
}
.menu-box{
  display:none;
  position:absolute;
  right:0;
  top:22px;
  background:#000;
  border:1px solid var(--green);
  min-width:150px;
  z-index:99;
}
.menu-box div{
  padding:8px 12px;
  cursor:pointer;
  user-select:none;
  font-size:13px;
}
.menu-box div:hover{
  background:var(--green);
  color:#000;
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-box{
  background:#000;
  border:2px solid var(--green);
  padding:14px;
  max-width:850px;
  width:92%;
}
.modal-box iframe,
.modal-box img,
.modal-box video,
.modal-box audio{
  max-width:100%;
  max-height:70vh;
}
</style>
</head>

<body>

<header>‚òÅÔ∏è B-Drive Cloud Storage</header>

<div class="status">
  <div class="status-box">
    <div class="spinner" id="spinner"></div>
    <div class="tick" id="tick">‚úî</div>
    <span id="statusText">Connecting‚Ä¶</span>
  </div>
</div>

<div class="container">

  <div class="toolbar">
    <button onclick="goHome()">Home</button>
    <button onclick="goBack()">Back</button>
    <button onclick="createFolder()">New Folder</button>
    <button onclick="pickFile()">Upload</button>
    <button onclick="refreshList()">Refresh</button>
  </div>

  <div class="progress" id="progressBox">
    <div class="bar" id="progressBar"></div>
  </div>

  <input type="file" id="fileInput" multiple hidden>
  <div id="fileList"></div>
</div>

<div class="modal" id="viewer">
  <div class="modal-box">
    <button onclick="closeViewer()">Close</button>
    <div id="viewerBody"></div>
  </div>
</div>

<script>
const API="https://b-drive-backend.onrender.com";
let currentPath="storage";
let history=[];

/* CONNECT */
(async()=>{
  const r=await fetch(API+"/ping");
  const d=await r.json();
  spinner.style.display="none";
  tick.style.display="block";
  statusText.textContent="Connected";
  loadList();
})();

/* LOAD */
async function loadList(path=currentPath){
  currentPath=path;
  const r=await fetch(API+"/list?path="+path);
  let items=await r.json();
  if(!Array.isArray(items)) items=[items];
  render(items);
}

/* REFRESH */
function refreshList(){
  loadList(currentPath);
}

/* RENDER */
function render(items){
  fileList.innerHTML="";
  items.forEach(i=>{
    const row=document.createElement("div");
    row.className="file-row";

    row.innerHTML=`
      <span class="filename">${i.type==="dir"?"üìÅ ":""}${i.name}</span>
      <div class="menu">
        <span class="menu-btn">‚ãÆ</span>
        <div class="menu-box">
          ${i.type==="file"?`<div onclick="previewFile(event,'${i.download_url}')">Preview</div>`:""}
          ${i.type==="file"?`<div onclick="downloadFile(event,'${i.download_url}','${i.name}')">Download</div>`:""}
          <div onclick="showDetails(event,'${i.path}')">Details</div>
          <div onclick="deleteRecursive(event,'${i.path}','${i.type}')">Delete</div>
        </div>
      </div>
    `;

    row.onclick=(e)=>{
      if(e.target.closest(".menu")) return;
      if(i.type==="dir"){
        history.push(currentPath);
        loadList(i.path);
      }
    };

    row.querySelector(".menu-btn").onclick=(e)=>{
      e.stopPropagation();
      closeMenus();
      row.querySelector(".menu-box").style.display="block";
    };

    fileList.appendChild(row);
  });
}

/* MENU */
document.addEventListener("click",closeMenus);
function closeMenus(){
  document.querySelectorAll(".menu-box").forEach(m=>m.style.display="none");
}

/* DELETE */
async function deleteRecursive(e,path,type){
  e.stopPropagation();
  if(!confirm("Delete permanently?")) return;

  const r=await fetch(API+"/list?path="+path);
  let items=await r.json();

  if(Array.isArray(items)){
    for(const it of items){
      await deleteRecursive({stopPropagation(){}},it.path,it.type);
    }
  }else{
    await fetch(API+"/delete",{
      method:"DELETE",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({path:items.path,sha:items.sha})
    });
  }
  loadList(currentPath);
}

/* UPLOAD */
function pickFile(){ fileInput.click(); }
fileInput.onchange=()=>{
  [...fileInput.files].forEach(f=>{
    const fd=new FormData();
    fd.append("file",f);
    fd.append("path",currentPath);

    const xhr=new XMLHttpRequest();
    xhr.upload.onprogress=e=>{
      progressBox.style.display="block";
      progressBar.style.width=(e.loaded/e.total*100)+"%";
    };
    xhr.onload=()=>{
      progressBox.style.display="none";
      loadList(currentPath);
    };
    xhr.open("POST",API+"/upload");
    xhr.send(fd);
  });
};

/* PREVIEW */
function previewFile(e,url){
  e.stopPropagation();
  viewerBody.innerHTML=`<iframe src="${url}" width="100%" height="500"></iframe>`;
  viewer.style.display="flex";
}
function closeViewer(){ viewer.style.display="none"; }

/* DETAILS */
async function showDetails(e,path){
  e.stopPropagation();
  const r=await fetch(API+"/details?path="+path);
  const d=await r.json();
  viewerBody.innerHTML=`
    <h3>Details</h3>
    <p><b>Name:</b> ${d.name}</p>
    <p><b>Type:</b> ${d.type}</p>
    <p><b>Size:</b> ${(d.size/1024).toFixed(2)} KB</p>
    ${d.filesCount?`<p><b>Files:</b> ${d.filesCount}</p>`:""}
    <p><b>Last Modified:</b> ${d.lastModified||"N/A"}</p>
  `;
  viewer.style.display="flex";
}

/* DOWNLOAD */
function downloadFile(e,url,name){
  e.stopPropagation();
  const a=document.createElement("a");
  a.href=url; a.download=name; a.click();
}

/* NAV */
function goBack(){ if(history.length) loadList(history.pop()); }
function goHome(){ history=[]; loadList("storage"); }

/* CREATE FOLDER */
function createFolder(){
  const n=prompt("Folder name?");
  if(!n) return;
  fetch(API+"/folder",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({path:currentPath+"/"+n})
  }).then(()=>loadList(currentPath));
}
</script>

</body>
</html>
